<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI Memory Graph (Sigma.js)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/2.4.0/sigma.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/graphology/0.25.4/graphology.umd.min.js"></script>
    <style>
      body {
        margin: 0;
        background: #020617;
        font-family: monospace;
      }
      #container {
        width: 100vw;
        height: 100vh;
      }
      #tooltip {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(30, 41, 59, 0.95);
        border: 1px solid #475569;
        border-radius: 8px;
        padding: 16px;
        max-width: 400px;
        display: none;
        z-index: 1000;
        color: #e5e7eb;
      }
      #tooltip h3 {
        margin: 0 0 8px 0;
        color: #facc15;
      }
      #tooltip .type {
        color: #94a3b8;
        font-size: 12px;
        margin-bottom: 12px;
      }
      #tooltip ul {
        margin: 0;
        padding-left: 20px;
      }
      #tooltip li {
        margin: 4px 0;
        color: #38bdf8;
      }
      #legend {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(30, 41, 59, 0.9);
        border: 1px solid #475569;
        border-radius: 8px;
        padding: 12px;
        color: #e5e7eb;
      }
      #legend h4 {
        margin: 0 0 8px 0;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin: 4px 0;
      }
      .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>

    <div id="tooltip">
      <h3 id="tooltip-title"></h3>
      <div id="tooltip-type" class="type"></div>
      <ul id="tooltip-observations"></ul>
    </div>

    <div id="legend">
      <h4>ðŸ“Š Memory Graph</h4>
      <div class="legend-item"><span class="legend-dot" style="background:#facc15"></span> Project</div>
      <div class="legend-item"><span class="legend-dot" style="background:#4ade80"></span> Entity</div>
      <div class="legend-item"><span class="legend-dot" style="background:#38bdf8"></span> Observation</div>
    </div>

    <script>
      // Load JSONL file
      async function loadJSONL(url) {
        const res = await fetch(url);
        const text = await res.text();
        return text.split('\n').filter(l => l.trim()).map(l => JSON.parse(l));
      }

      // Color by entity type
      function colorByType(type) {
        const colors = {
          "Project": "#facc15",
          "Person": "#4ade80",
          "Task": "#f87171",
          "Decision": "#a78bfa",
          "Technology": "#22d3ee",
          "Component": "#fb923c"
        };
        return colors[type] || "#94a3b8";
      }

      // Build graph from entities
      function buildGraph(entities) {
        const graph = new graphology.Graph();
        const entityTypes = new Set();

        entities.forEach(e => {
          if (e.entityType) entityTypes.add(e.entityType);
        });

        // Add type hub nodes
        let typeIndex = 0;
        entityTypes.forEach(type => {
          const angle = (2 * Math.PI * typeIndex) / entityTypes.size;
          graph.addNode(`type:${type}`, {
            label: type,
            x: Math.cos(angle) * 3,
            y: Math.sin(angle) * 3,
            size: 25,
            color: colorByType(type),
            nodeType: 'entityType'
          });
          typeIndex++;
        });

        // Add entity nodes
        entities.forEach((e, idx) => {
          const nodeId = `entity:${e.name}`;
          const typeNode = `type:${e.entityType}`;
          const typeAttrs = graph.getNodeAttributes(typeNode);

          const offset = (idx + 1) * 0.8;
          const angle = Math.random() * Math.PI * 2;

          graph.addNode(nodeId, {
            label: e.name,
            x: typeAttrs.x + Math.cos(angle) * offset,
            y: typeAttrs.y + Math.sin(angle) * offset,
            size: 15,
            color: colorByType(e.entityType),
            nodeType: 'entity',
            observations: e.observations || []
          });

          graph.addEdge(nodeId, typeNode, { size: 2, color: "#64748b" });

          // Add observation nodes
          if (e.observations) {
            e.observations.forEach((obs, obsIdx) => {
              const obsId = `obs:${e.name}:${obsIdx}`;
              const obsAngle = (2 * Math.PI * obsIdx) / e.observations.length;
              const obsOffset = 0.6;

              const entityAttrs = graph.getNodeAttributes(nodeId);
              graph.addNode(obsId, {
                label: obs.length > 25 ? obs.substring(0, 25) + '...' : obs,
                x: entityAttrs.x + Math.cos(obsAngle) * obsOffset,
                y: entityAttrs.y + Math.sin(obsAngle) * obsOffset,
                size: 8,
                color: "#38bdf8",
                nodeType: 'observation',
                fullText: obs
              });

              graph.addEdge(nodeId, obsId, { size: 1, color: "#334155" });
            });
          }
        });

        return graph;
      }

      // Main
      (async () => {
        const entities = await loadJSONL("memory.jsonl");
        const graph = buildGraph(entities);

        const renderer = new Sigma(graph, document.getElementById("container"), {
          renderEdgeLabels: false,
          labelDensity: 0.1,
          labelGridCellSize: 100,
          labelRenderedSizeThreshold: 5,
          defaultEdgeColor: '#475569',
          labelColor: { color: '#e5e7eb' }
        });

        // Tooltip
        const tooltip = document.getElementById('tooltip');
        const tooltipTitle = document.getElementById('tooltip-title');
        const tooltipType = document.getElementById('tooltip-type');
        const tooltipObs = document.getElementById('tooltip-observations');

        renderer.on("enterNode", ({ node }) => {
          const attrs = graph.getNodeAttributes(node);
          tooltipTitle.textContent = attrs.label;
          tooltipType.textContent = `Type: ${attrs.nodeType}`;
          tooltipObs.innerHTML = '';

          if (attrs.observations && attrs.observations.length > 0) {
            attrs.observations.forEach(obs => {
              const li = document.createElement('li');
              li.textContent = obs;
              tooltipObs.appendChild(li);
            });
          } else if (attrs.fullText) {
            const li = document.createElement('li');
            li.textContent = attrs.fullText;
            tooltipObs.appendChild(li);
          }

          tooltip.style.display = 'block';
        });

        renderer.on("leaveNode", () => {
          tooltip.style.display = 'none';
        });

        renderer.on("clickNode", ({ node }) => {
          console.log("Node:", node, graph.getNodeAttributes(node));
        });
      })();
    </script>
  </body>
</html>